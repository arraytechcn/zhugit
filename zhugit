#!/bin/bash

# ZhuGit - 朱氏Git操作工具
# 使用方法: zhugit [命令] [参数]

case "$1" in
    "init")
        echo "🚀 初始化Git仓库..."
        git init
        echo "✅ Git仓库初始化完成！"
        echo "💡 接下来可以："
        echo "   zhugit add [文件]     - 添加文件到暂存区"
        echo "   zhugit commit [信息]  - 提交更改"
        echo "   zhugit status        - 查看状态"
        ;;
    "new-project"|"new")
        if [ -z "$2" ]; then
            echo "❌ 请指定项目名称"
            echo "💡 使用方法: zhugit new-project <项目名称>"
        else
            echo "🚀 创建新项目: $2"
            mkdir "$2"
            cd "$2"
            git init
            echo "# $2" > README.md
            git add .
            git commit -m "初始提交: $2"
            echo "✅ 新项目 '$2' 创建完成！"
            echo "📁 项目位置: $(pwd)"
            echo "💡 接下来可以："
            echo "   zhugit status        - 查看状态"
            echo "   zhugit log          - 查看历史"
        fi
        ;;
    "connect-github"|"connect")
        if [ -z "$2" ]; then
            echo "❌ 请指定GitHub仓库地址"
            echo "💡 使用方法: zhugit connect-github <GitHub仓库URL>"
            echo "📋 示例: zhugit connect-github https://github.com/username/repo.git"
            echo ""
            echo "🎯 完整流程："
            echo "   1️⃣  zhugit quick-setup 项目名称"
            echo "   2️⃣  去 https://github.com/new 创建仓库"
            echo "   3️⃣  zhugit connect-github https://github.com/用户名/仓库名.git"
        else
            echo "🔗 连接到GitHub仓库: $2"
            echo "📋 步骤1: 检查并添加远程仓库..."
            if git remote get-url origin >/dev/null 2>&1; then
                echo "⚠️  远程仓库已存在，将更新URL"
                git remote set-url origin "$2"
            else
                git remote add origin "$2"
            fi
            
            # 检查当前分支名称
            current_branch=$(git branch --show-current)
            if [ -z "$current_branch" ]; then
                current_branch="main"
                echo "📋 步骤2: 创建main分支..."
                git checkout -b main
            fi
            
            echo "📋 步骤3: 推送代码到GitHub..."
            echo "📡 推送分支: $current_branch"
            git push -u origin "$current_branch"
            echo "✅ GitHub连接完成！"
            echo "📡 远程仓库: $2"
            echo ""
            echo "🎉 项目已成功上传到GitHub！"
            echo "🌐 查看项目: $2"
        fi
        ;;
    "quick-setup"|"setup")
        if [ -z "$2" ]; then
            echo "❌ 请指定项目名称"
            echo "💡 使用方法: zhugit quick-setup <项目名称>"
        else
            echo "🚀 快速设置项目: $2"
            echo "📋 步骤1: 创建项目目录..."
            if [ -d "$2" ]; then
                echo "⚠️  目录已存在，将使用现有目录"
            else
                mkdir "$2"
            fi
            cd "$2"
            echo "📋 步骤2: 初始化Git仓库..."
            if [ -d ".git" ]; then
                echo "⚠️  Git仓库已存在，将重新初始化"
                rm -rf .git
            fi
            git init
            echo "📋 步骤3: 创建README.md文件..."
            echo "# $2" > README.md
            echo "📋 步骤4: 添加文件到暂存区..."
            git add .
            echo "📋 步骤5: 提交初始版本..."
            git commit -m "初始提交: $2"
            echo "✅ 项目 '$2' 设置完成！"
            echo "📁 项目位置: $(pwd)"
            echo ""
            echo "🎯 下一步操作："
            echo "   1️⃣  创建GitHub仓库: 去 https://github.com/new 创建新仓库"
            echo "   2️⃣  连接GitHub: zhugit connect-github <GitHub仓库URL>"
            echo "   3️⃣  查看状态: zhugit status"
            echo ""
            echo "💡 完整示例："
            echo "   zhugit connect-github https://github.com/arraytechcn/$2.git"
        fi
        ;;
    "add")
        if [ -z "$2" ]; then
            echo "📁 添加所有文件到暂存区..."
            git add .
        else
            echo "📁 添加文件到暂存区: $2"
            git add "$2"
        fi
        echo "✅ 文件已添加到暂存区"
        ;;
    "checkout"|"co")
        echo "📥 检出项目..."
        git checkout "$2"
        ;;
    "update"|"up")
        echo "🔄 更新项目..."
        git pull local main
        ;;
    "commit"|"ci")
        echo "💾 提交更改..."
        git add .
        git commit -m "$2"
        git push local main
        echo "✅ 提交完成！"
        ;;
    "status"|"st")
        echo "📊 项目状态:"
        git status --short
        ;;
    "log"|"history")
        echo "📈 提交历史:"
        git log --oneline -10
        ;;
    "revert")
        echo "↩️ 恢复更改..."
        git checkout -- "$2"
        ;;
    "rollback"|"rb")
        if [ -z "$2" ]; then
            echo "❌ 请指定要回滚到的提交ID"
            echo "💡 使用方法: zhugit rollback <提交ID>"
            echo "📋 查看可用提交: zhugit log"
        else
            echo "🔄 回滚到提交: $2"
            echo "⚠️  注意：这将删除后续的提交历史"
            echo "💡 如需保留历史，请使用: zhugit rollback-to <提交ID>"
            git reset --hard "$2"
            echo "✅ 回滚完成！"
        fi
        ;;
    "rollback-soft"|"rbs")
        if [ -z "$2" ]; then
            echo "❌ 请指定要回滚到的提交ID"
            echo "💡 使用方法: zhugit rollback-soft <提交ID>"
            echo "📋 查看可用提交: zhugit log"
        else
            echo "🔄 软回滚到提交: $2 (保留更改)"
            git reset --soft "$2"
            echo "✅ 软回滚完成！更改已保留在暂存区"
        fi
        ;;
    "rollback-to"|"rbt")
        if [ -z "$2" ]; then
            echo "❌ 请指定要回滚到的提交ID"
            echo "💡 使用方法: zhugit rollback-to <提交ID>"
            echo "📋 查看可用提交: zhugit log"
        else
            echo "🔄 安全回滚到提交: $2 (保留历史记录)"
            echo "📝 这将创建一个新的回滚提交，保留所有历史"
            
            # 获取当前HEAD的提交信息
            current_commit=$(git rev-parse HEAD)
            current_message=$(git log --format=%s -1)
            
            # 重置到目标提交
            git reset --hard "$2"
            
            # 创建回滚提交
            git commit --allow-empty -m "🔄 回滚到: $2
原提交: $current_commit
原信息: $current_message
时间: $(date '+%Y-%m-%d %H:%M:%S')"
            
            echo "✅ 安全回滚完成！历史记录已保留"
            echo "📊 新的回滚提交已创建"
        fi
        ;;
    "diff")
        echo "🔍 查看差异:"
        git diff
        ;;
    "help"|*)
        echo "🚀 ZhuGit - 朱氏Git操作工具:"
        echo "  zhugit init            - 初始化Git仓库"
        echo "  zhugit new-project [名称] - 创建新项目(包含Git初始化)"
        echo "  zhugit connect-github [URL] - 连接到GitHub仓库"
        echo "  zhugit quick-setup [名称] - 快速设置项目"
        echo "  zhugit add [文件]      - 添加文件到暂存区"
        echo "  zhugit commit [信息]   - 提交更改"
        echo "  zhugit status          - 查看状态"
        echo "  zhugit log             - 查看历史"
        echo "  zhugit checkout [分支]  - 检出分支"
        echo "  zhugit update          - 更新项目"
        echo "  zhugit revert [文件]   - 恢复文件"
        echo "  zhugit rollback [ID]   - 硬回滚到指定提交"
        echo "  zhugit rollback-soft [ID] - 软回滚(保留更改)"
        echo "  zhugit rollback-to [ID] - 创建回滚提交"
        echo "  zhugit diff            - 查看差异"
        echo "  zhugit help            - 显示帮助"
        ;;
esac
